<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dan McGraw">
<meta name="dcterms.date" content="2024-08-08">

<title>Thurmond PA - R Scripting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Thurmond PA - R Scripting</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Dan McGraw <a href="mailto:daniel.e.mcgraw@usace.army.mil" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            USACE SAS EN-H
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 8, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>This walkthrough is to provide a description of R scripts/files used in the development of the J. Strom Thurmond Dam Hydrologic Hazard Curve (HHC). The readme files contained in the project folder provide a summary of various scripts. Algorithim development is an iterative process, so there was not a singular centralized script. The document will incorporate the contents of several scripts developed for the HHC. R is an open source, free software. All the libraries/functions used have extensive information online on their use and trouble shooting.</p>
<section id="period-of-record-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="period-of-record-data-analysis">Period of Record Data Analysis</h2>
<p>Data requests for existing period of record (POR) data should be completed through the home district’s water management section. Typical data stored for projects throughout the USACE portfolio range from observed lake elevation, stage, flow, precipitation, temperature, snow depth, snow water equivalent, and computed inflow at various time intervals.</p>
<p>The POR data for JST Dam was obtained from the (internal facing) Savannah District Water Management <a href="https://esasw6kbaaa0101.sas.ds.usace.army.mil/">website</a>. The data was copy-pasted from the historic data query into Notepad++ and saved as .txt file. The data needs to be delimited prior to use in R.</p>
<section id="data-import-formatting-and-export" class="level3">
<h3 class="anchored" data-anchor-id="data-import-formatting-and-export">Data Import, Formatting, and Export</h3>
<p>The following code blocks were taken from <em>ThurmondPOR_Data.R</em>. The first block below also serves as a format for scripting best practices. Commenting code is invaluable (comments are the only way I can remember what I did in the script, months later).</p>
<p>This section contains a commented header (note: <em># Header #####</em> will name a section of code). It is good practice to clear the environmental at the start of a script. The necessary libraries are also called at the top of a script. In order to load a library, it has to have been previously downloaded. <em>install.packages</em> has been included and commented out as an example. The line <em>theme_USACE.r</em> is ggplot theme created by Brian <a href="\share.hec.usace.army.mil\breaker\rTraining">Breaker</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Thurmond POR data ############################################################</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputs are raw text files copied from WM Site</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dan McGraw</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-March-2024</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Clear workspace</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Load Libraries</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tidyverse")</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"E:/R/theme_USACE.r"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step is to read the delimited test files containing the POR data. These are all saved in the same folder which is <em>pordir</em>. Note that the data should be in .csv or .txt files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read files ###################################################################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Locate directory/folder with POR data</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>pordir <span class="ot">&lt;-</span> <span class="st">"E:/1.Thurmond/Chapter 4/HH/Data/Project POR Data/"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create file path of the POR txt files</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>thur_elev_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"ThurmondDL_3-6-2024_ELEV.txt"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>thur_flows_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"ThurmondDL_3-6-2024_NetInflow_Discharge.txt"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>thur_stor_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"ThurmondDL_3-6-2024_STOR.txt"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>thur_gen_file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"ThurmondDL_3-6-2024_GEN.txt"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read text files</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="ot">&lt;-</span> <span class="fu">read.table</span>(thur_elev_file)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> <span class="fu">read.table</span>(thur_flows_file)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>thur_stor <span class="ot">&lt;-</span> <span class="fu">read.table</span>(thur_stor_file)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>thur_gen <span class="ot">&lt;-</span> <span class="fu">read.table</span>(thur_gen_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Headings were not read in with the data. These were added after import based on existing user knowledge of the fields. This code block is using <em>dplyr</em> from the tidyverse package. Tidyverse works very well with the pipe operator (%&gt;%). Think of this as:</p>
<p><em>new data name</em> &lt;- <em>old data name</em> &gt;input&gt; <em>function</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="ot">&lt;-</span> thur_elev <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Date =</span> V1,<span class="at">DOW =</span> V2, <span class="at">Elev_29 =</span> V3) </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Date =</span> V1,<span class="at">DOW =</span> V2, <span class="at">NetInflow =</span> V3, <span class="at">Discharge =</span> V4) </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>thur_stor <span class="ot">&lt;-</span> thur_stor <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Date =</span> V1,<span class="at">DOW =</span> V2, <span class="at">Storage =</span> V3) </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>thur_gen <span class="ot">&lt;-</span> thur_gen <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Date =</span> V1,<span class="at">DOW =</span> V2, <span class="at">Gen =</span> V3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An example of the <em>thur_flows</em> dataset is below. Note the data was downloaded in descending date, this will be important later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(thur_flows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date DOW NetInflow Discharge
1 03/05/2024 Tue     10412      6177
2 03/04/2024 Mon     15313      6490
3 03/03/2024 Sun      6656      6656
4 03/02/2024 Sat      6341      6694
5 03/01/2024 Fri      7259      4436
6 02/29/2024 Thu      2606      4371</code></pre>
</div>
</div>
<p>The day of the week was not significant for this analysis. It was dropped from the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="ot">&lt;-</span> thur_elev <span class="sc">%&gt;%</span> <span class="fu">select</span> (<span class="sc">-</span><span class="fu">c</span>(DOW))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">select</span> (<span class="sc">-</span><span class="fu">c</span>(DOW))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>thur_stor <span class="ot">&lt;-</span> thur_stor <span class="sc">%&gt;%</span> <span class="fu">select</span> (<span class="sc">-</span><span class="fu">c</span>(DOW))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The date field will be very important for the analysis. Initially, it is common for R to read the date field as a character data-type. This means there is no numerical basis to the values (the dates are just words). The dates need to be converted a date data-type for this analysis. For example, once the dates are formatted correctly, they can be arranged by increasing date. This is done using the <em>as.Date</em> function. Errors can arise when the dates are not formatted uniformly. The function allows several “try” inputs for cases like that. Another breakdown of the pipe operator is shown above the code block:</p>
<p><em>thur_flows_updated</em> = <em>thur_flows_existing</em> + a new DATE column (<em>mutate</em>), called <em>DT</em>, that will go before <em>NetInflow</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DT =</span> <span class="fu">as.Date</span>(Date,<span class="at">format =</span> <span class="st">"%m/%d/%Y"</span>),<span class="at">.before =</span> NetInflow )</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="ot">&lt;-</span> thur_elev <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DT =</span> <span class="fu">as.Date</span>(Date,<span class="at">format =</span> <span class="st">"%m/%d/%Y"</span>),<span class="at">.before =</span> Elev_29)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>thur_stor <span class="ot">&lt;-</span> thur_stor <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DT =</span> <span class="fu">as.Date</span>(Date,<span class="at">format =</span> <span class="st">"%m/%d/%Y"</span>),<span class="at">.before =</span> Storage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See the difference:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(thur_flows<span class="sc">$</span>Date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(thur_flows<span class="sc">$</span>DT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
</div>
<p>Now the dates can be arranged by increasing date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="ot">&lt;-</span> thur_elev <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(DT)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(DT)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>thur_stor <span class="ot">&lt;-</span> thur_stor <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(DT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An advantage of using R instead of excel is the ability to do column-wide functions without click &amp; drag. The elevation data needs to be in NAVD88. The conversion from NGVD29 to NAVD88 is: <span class="math display">\[ NAVD88 = NGVD29 - 0.7\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new dataframe (df) for NAVD88 elevation</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>thur_elev88 <span class="ot">&lt;-</span> thur_elev <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Elev_88 =</span> Elev_29 <span class="sc">-</span> <span class="fl">0.7</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the ngvd29 column from the navd88 df to avoid confusion</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>thur_elev88 <span class="ot">&lt;-</span> thur_elev88 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Elev_29))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point of the analysis the data was exported as csv files. These csv files could serve as a starting point for analysis in different scripts, without having to clean up the data as much (date will always need to be formatted <em>as.Date</em>). Note that an R &amp; DSS package exists: <a href="https://github.com/eheisman/dssrip" class="uri">https://github.com/eheisman/dssrip</a>. The <em>write.csv</em> function has been commented out so the code will not export any files during this walkthrough.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>thur_elev_outfile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"csv/Thurmond3-6-2024_ELEV.csv"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>thur_elev88_outfile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"csv/Thurmond3-6-2024_ELEV_88.csv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>thur_flows_outfile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"csv/Thurmond_3-6-2024_NetInflow_Discharge.csv"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>thur_stor_outfile <span class="ot">&lt;-</span> <span class="fu">paste0</span>(pordir,<span class="st">"csv/Thurmond_3-6-2024_STOR.csv"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(thur_elev,thur_elev_outfile)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(thur_elev88,thur_elev88_outfile)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(thur_flows,thur_flows_outfile)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(thur_stor,thur_stor_outfile)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="historic-inflows-pool-elevations" class="level3">
<h3 class="anchored" data-anchor-id="historic-inflows-pool-elevations">Historic Inflows &amp; Pool Elevations</h3>
<p>An important first step of data analysis is understanding what the data looks like. R was used to quickly provide historic pool levels, large inflows, and additional time series context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What years are contained within the POR</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>thryears <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">year</span>(thur_flows<span class="sc">$</span>DT))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What does the POR data look like</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> thur_flows,<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Discharge)) <span class="sc">+</span> <span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">theme_USACE</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>How many inflows above 80,000 cfs (arbitrary) have there been?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="sc">%&gt;%</span> <span class="fu">filter</span>(NetInflow <span class="sc">&gt;</span> <span class="dv">80000</span>)<span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>NetInflow))<span class="sc">+</span><span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">theme_USACE</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The top 10 largest pool elevations and inflows can be obtained as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAX Pool Elevations (top 10)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>thur_elev <span class="sc">%&gt;%</span> <span class="fu">top_n</span>(<span class="dv">10</span>,Elev_29)<span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(Elev_29))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Date         DT Elev_29
1  04/11/1964 1964-04-11  336.46
2  04/10/1964 1964-04-10  336.31
3  12/31/2015 2015-12-31  335.94
4  01/01/2016 2016-01-01  335.94
5  01/02/2016 2016-01-02  335.93
6  04/09/1964 1964-04-09  335.73
7  02/07/1998 1998-02-07  335.45
8  05/06/1964 1964-05-06  335.40
9  03/30/1964 1964-03-30  335.38
10 02/06/1998 1998-02-06  335.37</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAX Pool Elevations (top 10)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="sc">%&gt;%</span> <span class="fu">top_n</span>(<span class="dv">10</span>,NetInflow) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(NetInflow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Date         DT NetInflow Discharge
1  03/03/1971 1971-03-03    116127      3634
2  03/14/1975 1975-03-14    108026     14826
3  04/08/1964 1964-04-08    104761     36554
4  03/26/1964 1964-03-26    100266     14519
5  02/04/1998 1998-02-04     99121     16127
6  04/07/1964 1964-04-07     97413     12778
7  03/27/1964 1964-03-27     92612     15964
8  04/09/1964 1964-04-09     91136     70782
9  01/26/1978 1978-01-26     90983     15167
10 04/16/1969 1969-04-16     87295      6716</code></pre>
</div>
</div>
</section>
<section id="creating-annual-maxima-data" class="level3">
<h3 class="anchored" data-anchor-id="creating-annual-maxima-data">Creating Annual Maxima Data</h3>
<p>Hydrologic analysis uses annual maxima series (AMS) based on water years (starting on October 1). Using the correctly formatted date column, an AMS can be created for inflow and reservoir pool elevation/stage. Note that the reservoir inflow is regulated. The first step is determining the water year of each data point.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create separate columns of Year, Month, Day as numbers</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yr =</span> <span class="fu">year</span>(DT),<span class="at">Mon =</span> <span class="fu">month</span>(DT),<span class="at">Day =</span> <span class="fu">day</span>(DT))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ifelse is a binary yes/no operator. If the month greater than 10, WY = Yr+1</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>thur_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WaterYear =</span> <span class="fu">ifelse</span>(Mon <span class="sc">&gt;=</span> <span class="dv">10</span>, Yr <span class="sc">+</span> <span class="dv">1</span>, Yr))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>thur_elev88 <span class="ot">&lt;-</span> thur_elev88 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yr =</span> <span class="fu">year</span>(DT),<span class="at">Mon =</span> <span class="fu">month</span>(DT),<span class="at">Day =</span> <span class="fu">day</span>(DT))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>thur_elev88 <span class="ot">&lt;-</span> thur_elev88 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WaterYear =</span> <span class="fu">ifelse</span>(Mon <span class="sc">&gt;=</span> <span class="dv">10</span>, Yr <span class="sc">+</span> <span class="dv">1</span>, Yr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that the data can be grouped by water year, the annual max of each water year can be obtained</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>annual_max_flows <span class="ot">&lt;-</span> thur_flows <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(WaterYear) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">MaxInflow =</span> <span class="fu">max</span>(NetInflow),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">Date =</span> DT[<span class="fu">which.max</span>(NetInflow)],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">Month =</span> <span class="fu">month</span>(DT[<span class="fu">which.max</span>(NetInflow)]),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">Day =</span> <span class="fu">day</span>(DT[<span class="fu">which.max</span>(NetInflow)]))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>annual_max_stage88 <span class="ot">&lt;-</span> thur_elev88 <span class="sc">%&gt;%</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(WaterYear) <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Max_Elev =</span> <span class="fu">max</span>(Elev_88),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">Date =</span> DT[<span class="fu">which.max</span>(Elev_88)],</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">Month =</span> <span class="fu">month</span>(DT[<span class="fu">which.max</span>(Elev_88)]),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">Day =</span> <span class="fu">day</span>(DT[<span class="fu">which.max</span>(Elev_88)]))</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co"># export if necessary</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(annual_max_stage88,paste0(pordir,"Stage_AMS.csv"))</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(annual_max_flows,paste0(pordir,"Reg_Flow_AMS.csv"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="critical-inflow-duration-analysis" class="level3">
<h3 class="anchored" data-anchor-id="critical-inflow-duration-analysis">Critical Inflow Duration Analysis</h3>
<p>This section of code aimed to determine the distribution of inflow durations at JST Dam. The procedure used was from from RMC-TR-2018-03 - “Hydrologic Hazard Methodology for Semi-Quantitative Risk Assessments”. The TR defines <em>critical inflow duration</em> as the inflow duration that results in the highest water surface elevations for the reservoir of interest.</p>
<p>According to RMC-TR-2018-03, three to 5 (3-5) historical peak reservoir events should be identified. The inflow, discharge, and stage for these events should be used to determine the critical inflow duration. The TR states “select events that are consistent with the types of events likely to be the driver of extreme peak stages”.</p>
<p>Due to the highly regulated nature of JST dam, the driver of extreme stage could vary from shorter, localized inflows to the dam OR longer, basin-wide inflows to the dam. In order to reach an understanding of basin operations as well as a good starting point for the critical inflow duration, the following analyses were done:</p>
<section id="analyze-the-reservoir-elevation-rate-of-change" class="level4">
<h4 class="anchored" data-anchor-id="analyze-the-reservoir-elevation-rate-of-change">Analyze the reservoir elevation rate of change</h4>
<ol type="1">
<li>Determine the daily rate of change of reservoir elevation (ft/day)</li>
<li>Identify the top 150 daily rates (increasing)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and Set WSE Rate column to 0</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>thur_elev88<span class="sc">$</span>WSERate <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>thur_elev88<span class="sc">$</span>WSERate[<span class="dv">1</span>]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get rate of changer per day</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(thur_elev88<span class="sc">$</span>Elev_88)){</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  day2 <span class="ot">=</span> thur_elev88<span class="sc">$</span>Elev_88[i]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  day1 <span class="ot">=</span> thur_elev88<span class="sc">$</span>Elev_88[i<span class="dv">-1</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  stagedelta <span class="ot">=</span> day2 <span class="sc">-</span> day1</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  thur_elev88<span class="sc">$</span>WSERate[i] <span class="ot">=</span> stagedelta</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the top 150 rates</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>FastRise <span class="ot">&lt;-</span> thur_elev88 <span class="sc">%&gt;%</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(WSERate)) <span class="sc">%&gt;%</span> <span class="fu">slice_max</span>(WSERate,<span class="at">n=</span><span class="dv">150</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the rates against their corresponding reservoir elevations</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>FastRise,<span class="fu">aes</span>(<span class="at">x=</span>WSERate,<span class="at">y=</span>Elev_88))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Max Daily Rate of Change (ft/day)"</span>, <span class="at">y =</span> <span class="st">"Peak Reservoir Elev (NAVD88)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/wse rate-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is helpful, but it can only tell so much since the inflow data is daily.</p>
</section>
<section id="determine-the-inflow-duration-corresponding-to-the-reservoir-pool-ams" class="level4">
<h4 class="anchored" data-anchor-id="determine-the-inflow-duration-corresponding-to-the-reservoir-pool-ams">Determine the inflow duration corresponding to the reservoir pool AMS</h4>
<ol type="1">
<li>Loop through all high pool events and obtain corresponding inflow and discharge hydrographs from 7 days before and after</li>
<li>Find days during event where inflow &gt; discharge</li>
<li>Save the hydrograph image and table</li>
<li>Create distribution of inflow durations</li>
</ol>
<p>This code will save a csv and png of the inflow event</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co"> annual_max_stage88$Date is a formatted date column</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>ams_dates <span class="ot">&lt;-</span> annual_max_stage88<span class="sc">$</span>Date</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ams_dates &lt;- annual_max_flows$Date</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>eventDTs <span class="ot">&lt;-</span> ams_dates</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab flow hydrographs 14 days before and after max pool</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>eventDTs_start <span class="ot">&lt;-</span> eventDTs <span class="sc">-</span> <span class="dv">7</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>eventDTs_end <span class="ot">&lt;-</span> eventDTs <span class="sc">+</span> <span class="dv">7</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>thur_rep_hydrographs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>thur_flood_durations <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>flow.colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inflow"</span> <span class="ot">=</span> <span class="st">"#333BFF"</span>, <span class="st">"Outflow"</span> <span class="ot">=</span> <span class="st">"orangered2"</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(eventDTs)){</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  hist_pool_date <span class="ot">&lt;-</span> eventDTs[i]</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  dt1 <span class="ot">&lt;-</span> <span class="fu">which</span>(thur_flows<span class="sc">$</span>DT <span class="sc">==</span> eventDTs_start[i])</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  dt2 <span class="ot">&lt;-</span> <span class="fu">which</span>(thur_flows<span class="sc">$</span>DT <span class="sc">==</span> eventDTs_end[i])</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (eventDTs_start[i] <span class="sc">&lt;</span> thur_flows<span class="sc">$</span>DT[<span class="dv">1</span>]){</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    dt1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  hydrograph <span class="ot">&lt;-</span> thur_flows[dt1<span class="sc">:</span>dt2,]</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  hydrograph<span class="sc">$</span>Event <span class="ot">&lt;-</span> eventDTs[i]</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  thur_rep_hydrographs[[i]] <span class="ot">&lt;-</span> hydrograph</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  plot_date <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">format</span>(hist_pool_date, <span class="st">"%d-%b-%Y"</span>))</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  flood_dur_plot<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="at">data =</span> hydrograph)<span class="sc">+</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>NetInflow,<span class="at">color=</span><span class="st">"Inflow"</span>))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>NetInflow,<span class="at">color=</span><span class="st">"Inflow"</span>))<span class="sc">+</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Discharge,<span class="at">color=</span><span class="st">"Outflow"</span>))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Discharge,<span class="at">color=</span><span class="st">"Outflow"</span>))<span class="sc">+</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">"Record Pool Event on "</span>,plot_date))<span class="sc">+</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 day"</span>)<span class="sc">+</span><span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Date"</span>,<span class="at">y=</span><span class="st">"Discharge(cfs)"</span>,<span class="at">color =</span> <span class="st">"Legend"</span>)<span class="sc">+</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> flow.colors)<span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.8</span>))</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find where Inflow &gt; outflow for flood duration</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  flood_dates <span class="ot">&lt;-</span> hydrograph<span class="sc">$</span>DT[hydrograph<span class="sc">$</span>NetInflow <span class="sc">&gt;=</span> hydrograph<span class="sc">$</span>Discharge]</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>  peakflowdate <span class="ot">&lt;-</span> hydrograph<span class="sc">$</span>DT[<span class="fu">max</span>(hydrograph<span class="sc">$</span>NetInflow) <span class="sc">==</span> hydrograph<span class="sc">$</span>NetInflow]</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>  event_index <span class="ot">&lt;-</span> <span class="fu">which</span>(flood_dates <span class="sc">==</span> peakflowdate)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(event_index) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    event_index <span class="ot">&lt;-</span> <span class="fu">length</span>(flood_dates)<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find consecutive dates around eventDT</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  start_index <span class="ot">&lt;-</span> event_index</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  end_index <span class="ot">&lt;-</span> event_index</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the start index to include previous consecutive dates</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (start_index <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> flood_dates[start_index] <span class="sc">-</span> flood_dates[start_index <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    start_index <span class="ot">&lt;-</span> start_index <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Expand the end index to include following consecutive dates</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (end_index <span class="sc">&lt;</span> <span class="fu">length</span>(flood_dates) <span class="sc">&amp;&amp;</span> flood_dates[end_index <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> flood_dates[end_index] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    end_index <span class="ot">&lt;-</span> end_index <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract consecutive dates</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  consecutive_dates <span class="ot">&lt;-</span> flood_dates[start_index<span class="sc">:</span>end_index]</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flood Duration in Days</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>  flood_dur <span class="ot">&lt;-</span> <span class="fu">length</span>(consecutive_dates)</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># march 21 2006 is tough, duration likely = 4-5 but outflow was always larger than inflow</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># peak outflow matched peak inflow</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>  thur_flood_durations[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Event =</span> hist_pool_date,<span class="at">Dur_days =</span> flood_dur)</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write CSV - uncomment to save</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">#write.csv(hydrograph,paste0("E:/1.Thurmond/Chapter 4/HH/Data/Project POR Data/FloodDurations/Flood_",hist_pool_date,".csv"),row.names = F)</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save plot of flood event - uncomment to save </span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ggsave(paste0("E:/1.Thurmond/Chapter 4/HH/Data/Project POR Data/FloodDurations/Plots/",hist_pool_date,".png"),</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>         <span class="co">#flood_dur_plot,width = 8, height = 6,dpi = 300)</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the results to a usable df</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>thur_dur <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind.data.frame,thur_flood_durations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>thur_dur</em> contains the inflow duration of each high pool event. This was plotted as a histogram with a binwidth of 1-day to determine an initial estimate for the critical inflow duration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mdur <span class="ot">&lt;-</span> <span class="fu">mean</span>(thur_dur<span class="sc">$</span>Dur_days)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sddur <span class="ot">&lt;-</span> <span class="fu">sd</span>(thur_dur<span class="sc">$</span>Dur_days)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>meddur <span class="ot">&lt;-</span> <span class="fu">median</span>(thur_dur<span class="sc">$</span>Dur_days)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Base R does not have a Mode function.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>Mode <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  ux <span class="ot">&lt;-</span> <span class="fu">unique</span>(x)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  ux[<span class="fu">which.max</span>(<span class="fu">tabulate</span>(<span class="fu">match</span>(x, ux)))]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the mode</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The mode is: "</span>,<span class="fu">Mode</span>(thur_dur<span class="sc">$</span>Dur_days),<span class="st">" days"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The mode is: 4 days"</code></pre>
</div>
</div>
<p>The resulting hyetograph is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setting up a ggplot looks worse than it is</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> thur_dur,<span class="fu">aes</span>(<span class="at">x=</span>Dur_days))<span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth=</span><span class="dv">1</span>,<span class="at">fill=</span>histcolor,<span class="at">color=</span>linecolor,<span class="at">alpha=</span><span class="fl">0.9</span>)<span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">14</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Flood Duration (Days)"</span>,<span class="at">y=</span><span class="st">"Count"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Based on AMS Flood Events (1962 - 2024)"</span>)<span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribution of Flood Durations at Thurmond Dam"</span>)<span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mdur, <span class="at">color=</span>meancolor)<span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> (mdur<span class="sc">+</span>sddur), <span class="at">color=</span>sdcolor, <span class="at">linetype =</span> <span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> (mdur<span class="sc">-</span>sddur), <span class="at">color=</span>sdcolor, <span class="at">linetype =</span> <span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x=</span>mdur, <span class="at">label=</span><span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Mean = "</span>,<span class="fu">round</span>(mdur,<span class="dv">2</span>),<span class="at">sep=</span><span class="st">""</span>),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">y=</span><span class="fl">7.5</span>), <span class="at">colour=</span>meancolor, <span class="at">angle=</span><span class="dv">90</span>)<span class="sc">+</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x=</span>(mdur<span class="sc">+</span>sddur), <span class="at">label=</span><span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">+1SD = "</span>,<span class="fu">round</span>(mdur<span class="sc">+</span>sddur,<span class="dv">2</span>),<span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">y=</span><span class="fl">7.5</span>), <span class="at">colour=</span>sdcolor, <span class="at">angle=</span><span class="dv">90</span>)<span class="sc">+</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x=</span>(mdur<span class="sc">-</span>sddur), <span class="at">label=</span><span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">-1SD = "</span>,<span class="fu">round</span>(mdur<span class="sc">-</span>sddur,<span class="dv">2</span>),<span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">y=</span><span class="fl">7.5</span>), <span class="at">colour=</span>sdcolor, <span class="at">angle=</span><span class="dv">90</span>)<span class="sc">+</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/duration hist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Based on the results of the AMS duration distribution, the critical inflow duration is likely 3-, 4-, or 5-days. With this in mind, five historical peak reservoir events were identified to estimate a final critical duration. The loop used to create the inflow duration distribution contained a code to export a csv and png of each AMS event. These were used to estimate a final critical inflow duration. This has been replicated below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>event <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"11-Apr-1964"</span>,<span class="st">"30-Mar-1964"</span>,<span class="st">"3-Mar-1971"</span>,<span class="st">"17-Mar-1975"</span>,<span class="st">"7-Feb-1998"</span>,<span class="st">"1-Jan-2016"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>duration <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="fl">4.5</span>,<span class="fl">4.5</span>,<span class="dv">4</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>mean_inflow_dur <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(duration),<span class="dv">2</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>geomean_inflow_dur <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">mean</span>(<span class="fu">log</span>(duration))),<span class="dv">2</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The mean inflow duration is "</span>,mean_inflow_dur,<span class="st">"</span><span class="sc">\n</span><span class="st">The geometric mean inflow duration is "</span>, geomean_inflow_dur)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The mean inflow duration is  4.33 
The geometric mean inflow duration is  4.32</code></pre>
</div>
</div>
<p>Both 4-day and 5-day could be considered for the critical inflow duration. During the project, the 4-day inflow was selected as the critical duration.</p>
<p>As a preemptive analysis of seasonallity, the stage seasonallity was analyzed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> annual_max_stage88,<span class="fu">aes</span>(<span class="at">x =</span> Month))<span class="sc">+</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth=</span><span class="dv">1</span>,<span class="at">fill=</span><span class="st">"lightblue"</span>,<span class="at">color=</span><span class="st">"black"</span>,<span class="at">alpha=</span><span class="fl">0.9</span>)<span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density</span>(<span class="fu">aes</span>(<span class="at">y =</span> ..count..), <span class="at">geom =</span> <span class="st">"line"</span>, <span class="at">color =</span> <span class="st">"green3"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">12</span>,<span class="dv">1</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Jan"</span>,<span class="st">"Feb"</span>,<span class="st">"Mar"</span>,<span class="st">"Apr"</span>,<span class="st">"May"</span>,<span class="st">"June"</span>,<span class="st">"July"</span>,<span class="st">"Aug"</span>,<span class="st">"Sept"</span>,<span class="st">"Oct"</span>,<span class="st">"Nov"</span>,<span class="st">"Dec"</span>))<span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">20</span>,<span class="dv">2</span>),<span class="at">minor_breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">20</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month"</span>,<span class="at">y=</span><span class="st">"Count"</span>,<span class="at">subtitle =</span> <span class="st">"Based on AMS of POR Stage Elev.(1962 - 2024)"</span>)<span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Flood Seasonality at Thurmond Dam"</span>)<span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/stage season-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="unregulated-4-day-inflow-ams" class="level2">
<h2 class="anchored" data-anchor-id="unregulated-4-day-inflow-ams">Unregulated 4-day Inflow AMS</h2>
<p>The next steps were to create a timeseries of unregulated inflow data that can be used to create an AMS of 4-day inflow volumes. This section incorporates code used in <em>CreatingUnregulatedData_Augusta.R</em> and <em>Crtical Volume Duration.R</em>.</p>
<p>The Augusta USGS Streamgage was the subject of a 1990 USACE &amp; USGS report that analyzed the relationship between regulated and unregulated flow-frequency estimates. Due to the existence of this study and the longer gage record, the Augusta gage was used as the primary data source for inflow data. The overlapping record of the Augusta gage with the former USGS streamgage at JST Dam was used to verify the drainage area ratio from the design memo (0.93).</p>
<p><span class="math display">\[ Q_T = 0.93 * Q_A\]</span></p>
<p>In order to create a 4-day inflow volume annual maximum series (AMS), the daily streamflow data at the Augusta gage was processed using the following steps:</p>
<ol type="1">
<li><p>The effect of regulation was assumed to start in 1951, which was when deliberate impoundment began.</p></li>
<li><p>Daily regulated streamflow data at Augusta was converted to unregulated daily streamflow using the relationship shown in Figure 14 (PA Report - Chapter 4). This figure was digitized by hand from the 1990 study. Unregulated flows were interpolated from the curve shown in the figure.</p></li>
<li><p>4-day unregulated volumes were estimated from available daily unregulated streamflow data, now spanning 1883 – present (with some gaps)</p></li>
<li><p>4-day unregulated volume AMS was obtained for each water year</p></li>
<li><p>The peak-to-volume ratio was calculated using the Augusta gage peak-flow AMS. The peak flow was divided by the 4-day volume for corresponding floods. The average peak-to-volume ratio was 1.54.</p></li>
<li><p>The peak-to-volume ratio was used to estimate the 4-day volume annual maximum values for the gaps in the daily data (1892 to 1896 and 1906 to 1925).</p></li>
<li><p>The drainage area ratio (0.93) was applied to the 4-day volume AMS (regardless of year) to estimate the 4-day inflow volume AMS at Thurmond Dam.</p></li>
</ol>
<p>These steps &amp; figures will be replicated below.</p>
<section id="unregulated-inflow-data" class="level3">
<h3 class="anchored" data-anchor-id="unregulated-inflow-data">Unregulated Inflow Data</h3>
<p>Before any of the steps above, the data should be imported and formatted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Augusta Daily &amp; Format Dates</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dataRetrieval"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Import using Augusta Site Number</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>siteNo <span class="ot">&lt;-</span> <span class="st">"02197000"</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>pCode <span class="ot">&lt;-</span> <span class="st">"00060"</span> <span class="co">#00061 - # Check codes from USGS</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>start.date <span class="ot">&lt;-</span> <span class="st">"1700-01-01"</span> <span class="co"># arbitraty to get all info</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>end.date <span class="ot">&lt;-</span> <span class="st">"2024-12-31"</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>augusta_daily <span class="ot">&lt;-</span> <span class="fu">readNWISdv</span>(<span class="at">siteNumbers =</span> siteNo,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">parameterCd =</span> pCode,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">startDate =</span> start.date,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">endDate =</span> end.date)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>augusta_daily <span class="ot">&lt;-</span> <span class="fu">renameNWISColumns</span>(augusta_daily)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>augusta_daily <span class="ot">&lt;-</span> augusta_daily <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DT =</span> <span class="fu">as.Date</span>(Date),<span class="at">.before =</span> Flow)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add water year column</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>augusta_daily <span class="ot">&lt;-</span> augusta_daily <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yr =</span> <span class="fu">year</span>(DT),<span class="at">Mon =</span> <span class="fu">month</span>(DT),<span class="at">Day =</span> <span class="fu">day</span>(DT))</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>augusta_daily <span class="ot">&lt;-</span> augusta_daily <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WaterYear =</span> <span class="fu">ifelse</span>(Mon <span class="sc">&gt;</span> <span class="dv">9</span>, Yr <span class="sc">+</span> <span class="dv">1</span>, Yr))</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure the data is there</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> augusta_daily) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Flow)) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The regulated-unregulated relationship was digitized from the 1990 report and imported into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Digitized Data for Figure 35 (1990) - Exceedance Prob for Unregulated and Regulated</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>fig35 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"E:/1.Thurmond/Chapter 4/HH/Data/Savannah River - USGS Unregulated Study/Figure35data.csv"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>fig35 <span class="ot">&lt;-</span> fig35 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">NEP =</span> <span class="dv">100</span><span class="sc">-</span>ExceedanceProb)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Reg and Unreg at Augusta</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>augusta_conversion <span class="ot">&lt;-</span> fig35 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Aug_RegQ =</span> PeakQRegulated,<span class="at">Aug_UnregQ =</span> PeakQUnregulated)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>augusta_conversion <span class="ot">&lt;-</span> augusta_conversion <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(Aug_RegQ,Aug_UnregQ))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Recreate Figure 35</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>logscalebreaks <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1000</span>,<span class="dv">5000</span>,<span class="dv">10000</span>,<span class="dv">20000</span>,<span class="dv">50000</span>,<span class="dv">100000</span>,<span class="dv">200000</span>,<span class="dv">500000</span>,<span class="dv">1000000</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>logscaleminor_breaks <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">2000</span>, <span class="dv">9000</span>, <span class="at">by =</span> <span class="dv">1000</span>),<span class="fu">seq</span>(<span class="dv">20000</span>, <span class="dv">90000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">seq</span>(<span class="dv">200000</span>, <span class="dv">900000</span>, <span class="at">by =</span> <span class="dv">100000</span>))</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>fig35,<span class="fu">aes</span>(<span class="at">x=</span>PeakQUnregulated,<span class="at">y=</span>PeakQRegulated))<span class="sc">+</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Savannah River at Augusta, GA (02197000)"</span>)<span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Unregulated Discharge (cfs)"</span>,<span class="at">y=</span><span class="st">"Regulated Discharge (cfs)"</span>,<span class="at">subtitle =</span> <span class="st">"Relation between regulated peak discharges and unregulated peak discharges"</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Legend"</span>)<span class="sc">+</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),<span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),<span class="at">legend.position =</span> <span class="st">"bottom"</span>)<span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue1"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">drop0trailing =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">breaks =</span> logscalebreaks,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">minor_breaks =</span> logscaleminor_breaks)<span class="sc">+</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">drop0trailing =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">breaks =</span> logscalebreaks,</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">minor_breaks =</span> logscaleminor_breaks)<span class="sc">+</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">5000</span>,<span class="dv">1000000</span>),<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">5000</span>,<span class="dv">1000000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/unreg-reg-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Peak Flow dataset at Augusta will also be used. This data was obtained from the USGS website. Additional post processing was done to make this easier (i.e.&nbsp;some manual entry to Flow Notes)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import and Format</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>augusta_peak_ams <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"E:/1.Thurmond/Chapter 4/HH/Data/Augusta Gage/csv/Augusta_Peak_AMS.csv"</span>,<span class="at">header =</span> T)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>augusta_peak_ams <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DT =</span> <span class="fu">as.Date</span>(Date),<span class="at">.before =</span> Flow)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>augusta_peak_ams <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yr =</span> <span class="fu">year</span>(DT),<span class="at">Mon =</span> <span class="fu">month</span>(DT),<span class="at">Day =</span> <span class="fu">day</span>(DT))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>augusta_peak_ams <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WaterYear =</span> <span class="fu">ifelse</span>(Mon <span class="sc">&gt;</span> <span class="dv">9</span>, Yr <span class="sc">+</span> <span class="dv">1</span>, Yr))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>augusta_peak_ams <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Peak_Flow =</span> Flow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>The effect of regulation was assumed to start in 1951, which was when deliberate impoundment began.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regulation Assumed to start in 1951</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>regulation_wy <span class="ot">&lt;-</span> <span class="dv">1951</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>pre_reg <span class="ot">&lt;-</span> augusta_daily <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WaterYear <span class="sc">&lt;</span> regulation_wy)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>aug_reg <span class="ot">&lt;-</span> augusta_daily <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WaterYear <span class="sc">&gt;=</span> regulation_wy)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>pre_reg_peak <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WaterYear <span class="sc">&lt;</span> regulation_wy)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>aug_reg_peak <span class="ot">&lt;-</span> augusta_peak_ams <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WaterYear <span class="sc">&gt;=</span> regulation_wy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Daily regulated streamflow data at Augusta was converted to unregulated daily streamflow using the relationship shown in the relationship above. This figure was digitized by hand from the 1990 study. Unregulated flows were interpolated from the curve shown in the figure.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate Unregulated from approx function</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>Augusta_Unreg <span class="ot">&lt;-</span> <span class="fu">approx</span>(augusta_conversion<span class="sc">$</span>Aug_RegQ, augusta_conversion<span class="sc">$</span>Aug_UnregQ, <span class="at">xout =</span> aug_reg<span class="sc">$</span>Flow)[<span class="dv">2</span>]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>Augusta_Unreg_peak <span class="ot">&lt;-</span> <span class="fu">approx</span>(augusta_conversion<span class="sc">$</span>Aug_RegQ, augusta_conversion<span class="sc">$</span>Aug_UnregQ,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">xout=</span>aug_reg_peak<span class="sc">$</span>Peak_Flow)[<span class="dv">2</span>]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add to regulated data</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>aug_reg <span class="ot">&lt;-</span> aug_reg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Unregulated_Flow =</span> <span class="fu">round</span>(Augusta_Unreg<span class="sc">$</span>y,<span class="dv">0</span>))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>aug_reg_peak <span class="ot">&lt;-</span> aug_reg_peak <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Unregulated_PeakFlow =</span> <span class="fu">round</span>(Augusta_Unreg_peak<span class="sc">$</span>y,<span class="dv">0</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create a 1:1 column of unregulated flow to make bind_rows easier</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>pre_reg <span class="ot">&lt;-</span> pre_reg <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Unregulated_Flow =</span> <span class="fu">round</span>(Flow,<span class="dv">0</span>))</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>pre_reg_peak <span class="ot">&lt;-</span> pre_reg_peak <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Unregulated_PeakFlow =</span> <span class="fu">round</span>(Peak_Flow,<span class="dv">0</span>))</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine datasets</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>augusta_daily_unreg <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pre_reg,aug_reg)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>AMS_Peak <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pre_reg_peak,aug_reg_peak)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any confusion</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Augusta_Unreg)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(Augusta_Unreg_peak)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results for sanity </span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> augusta_daily_unreg) <span class="sc">+</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Unregulated_Flow,<span class="at">color =</span> <span class="st">"Unregulated"</span>))<span class="sc">+</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>DT,<span class="at">y=</span>Flow,<span class="at">color=</span><span class="st">"Existing"</span>))<span class="sc">+</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Daily Flow (cfs)"</span>,</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Daily Flow Values Augusta (02197000)"</span>,</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Post-WY 1951 Converted to Unregulated"</span>)<span class="sc">+</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">250000</span>,<span class="dv">50000</span>),<span class="at">minor_breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">250000</span>,<span class="dv">10000</span>))<span class="sc">+</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">breaks =</span> <span class="st">"10 year"</span>,<span class="at">minor_breaks =</span> <span class="st">"1 year"</span>)<span class="sc">+</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#377EB8"</span>, <span class="st">"red2"</span>), </span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">name =</span> <span class="st">"Legend"</span>, </span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Existing"</span>,<span class="st">"Unregulated"</span>))<span class="sc">+</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),<span class="at">legend.position =</span> <span class="fu">c</span>(.<span class="dv">85</span>,.<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>4-day unregulated volumes were estimated from available daily unregulated streamflow data, now spanning 1883 – present (with some gaps)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Data with gaps to avoid rolling mean over the gaps (i.e. 1891-12-31 &amp; 1896-01-01)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>complete_dates <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(augusta_daily_unreg<span class="sc">$</span>DT), <span class="fu">max</span>(augusta_daily_unreg<span class="sc">$</span>Date), <span class="at">by =</span> <span class="st">"day"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>aug_unreg_complete <span class="ot">&lt;-</span> <span class="fu">merge</span>(augusta_daily_unreg, <span class="fu">data.frame</span>(<span class="at">Date =</span> complete_dates), <span class="at">by =</span> <span class="st">"Date"</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># aug_unreg_complete[3010:3020,]  # check</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#naniar::vis_miss(aug_unreg_complete) # see gaps in data, uncomment to use</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>critdur <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># rollmean is a 4 day rolling average. rollmeanr indicates that the window is aligned to the "right"</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This will compute a time series of 4-day inflow volumes</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>aug_unreg_complete <span class="ot">&lt;-</span> aug_unreg_complete <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">VolDur_4day =</span> <span class="fu">round</span>(<span class="fu">rollmeanr</span>(Unregulated_Flow,<span class="at">k =</span> critdur, <span class="at">fill=</span><span class="cn">NA</span>),<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>4-day unregulated volume AMS was obtained for each water year</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>AMS_4day <span class="ot">&lt;-</span> aug_unreg_complete <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by WY</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(WaterYear) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Take the largest value from each WY</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">1</span>, VolDur_4day) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensures no duplicate years</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(WaterYear, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine Peak and 4-day AMS to help stay organized</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> <span class="fu">left_join</span>(AMS_Peak,AMS_4day,<span class="at">by =</span> <span class="st">"WaterYear"</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(all_AMS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Agency"               "Site"                 "Date.x"              
 [4] "DT.x"                 "Peak_Flow"            "Flow_notes"          
 [7] "Gage"                 "Gage_notes"           "Yr.x"                
[10] "Mon.x"                "Day.x"                "WaterYear"           
[13] "Unregulated_PeakFlow" "Date.y"               "agency_cd"           
[16] "site_no"              "DT.y"                 "Flow"                
[19] "Flow_cd"              "Yr.y"                 "Mon.y"               
[22] "Day.y"                "Unregulated_Flow"     "VolDur_4day"         </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(DT.x,Peak_Flow,Flow_notes,WaterYear,Unregulated_PeakFlow,DT.y,Unregulated_Flow,VolDur_4day))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">DT_Peak =</span> DT.x, <span class="at">DT_Daily =</span> DT.y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>The peak-to-volume ratio was calculated using the Augusta gage peak-flow AMS. The peak flow was divided by the 4-day volume for corresponding floods. The average peak-to-volume ratio was 1.54.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the peaks and 4-day vols that are from the same event. 4 is the search threshold then</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>matchingAMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DT_Peak <span class="sc">&gt;=</span> DT_Daily <span class="sc">-</span> <span class="dv">4</span> <span class="sc">|</span> DT_Peak <span class="sc">&lt;=</span> DT_Daily <span class="sc">+</span> <span class="dv">4</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>matchingAMS <span class="ot">&lt;-</span> matchingAMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">PeaktoVol =</span> Unregulated_PeakFlow<span class="sc">/</span>VolDur_4day)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Now Add this peak to vol data back to the AMS dataset</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Ratio_Peak_4d =</span> <span class="fu">ifelse</span>(DT_Peak <span class="sc">&gt;=</span> DT_Daily <span class="sc">-</span> <span class="dv">4</span> <span class="sc">|</span> DT_Peak <span class="sc">&lt;=</span> DT_Daily <span class="sc">+</span> <span class="dv">4</span>,Unregulated_PeakFlow<span class="sc">/</span>VolDur_4day,<span class="cn">NA</span>))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"The mean peak-to-volume ratio is "</span>,<span class="fu">round</span>(<span class="fu">mean</span>(matchingAMS<span class="sc">$</span>PeaktoVol),<span class="dv">2</span>),<span class="st">"</span><span class="sc">\n</span><span class="st">The geometric mean peak-to-volume ratio is "</span>, <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">mean</span>(<span class="fu">log</span>(matchingAMS<span class="sc">$</span>PeaktoVol))),<span class="dv">2</span>),<span class="st">"</span><span class="sc">\n</span><span class="st">The median peak-to-volume ratio is "</span>,<span class="fu">round</span>(<span class="fu">median</span>(matchingAMS<span class="sc">$</span>PeaktoVol),<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The mean peak-to-volume ratio is  1.54 
The geometric mean peak-to-volume ratio is  1.46 
The median peak-to-volume ratio is  1.39</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> matchingAMS)<span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span>PeaktoVol),<span class="at">fill=</span><span class="st">"lightblue"</span>,<span class="at">color=</span><span class="st">"black"</span>,<span class="at">alpha=</span><span class="fl">0.9</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.9</span>,<span class="fl">3.0</span>,<span class="fl">0.1</span>))<span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_USACE</span>()<span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Ratio of Peak Flow to 4-Day Volume at Augusta (02197000)"</span>)<span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Peak Flow/4-Day Vol"</span>, <span class="at">y=</span><span class="st">"Count"</span>)<span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.9</span>,<span class="fl">3.0</span>,<span class="fl">0.1</span>),<span class="at">minor_breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="fl">3.0</span>,<span class="fl">0.05</span>))<span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">25</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(matchingAMS<span class="sc">$</span>PeaktoVol), <span class="at">color=</span><span class="st">"orange2"</span>)<span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="fl">6.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="JST_inR_files/figure-html/peak to vol plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="6" type="1">
<li>The peak-to-volume ratio was used to estimate the 4-day volume annual maximum values for the gaps in the daily data (1892 to 1896 and 1906 to 1925).</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Peak to volume ratio</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>PtVratio_4day <span class="ot">&lt;-</span> <span class="fu">mean</span>(matchingAMS<span class="sc">$</span>PeaktoVol)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate missing 4 day volumes</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Peak_to_4day =</span> <span class="fu">round</span>(Unregulated_PeakFlow<span class="sc">/</span>PtVratio_4day,<span class="dv">0</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Complete_4Day_AMS =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(all_AMS<span class="sc">$</span>VolDur_4day),Peak_to_4day,VolDur_4day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>The drainage area ratio (0.93) was applied to the 4-day volume AMS (regardless of year) to estimate the 4-day inflow volume AMS at Thurmond Dam.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Previously calculated drainage area ratio</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>DAratio <span class="ot">&lt;-</span> <span class="fl">0.93</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiply the Augusta AMS values by the DA ratio</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Thurm_AMS_4day =</span> <span class="fu">round</span>(DAratio<span class="sc">*</span>Complete_4Day_AMS,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>BONUS STEP: Prepare the data to be used in BestFit. This will use the flow notes to set perception threshold values &amp; interval values (assumed to be +/- 20%). The interval calculation can be tough to decipher via code. It has been written out as an equation below.</p>
<p><span class="math display">\[ Interval_L = 0.80 * 0.93 * PeakQ/PeakToVol\]</span> <span class="math display">\[ Interval_U = 1.20 * 0.93 * PeakQ/PeakToVol\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename some columns to make it easier - this is because my variable naming was not as intuitive as it should have been</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Aug_AMS_1day =</span> Unregulated_Flow, </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Aug_AMS_4day =</span> VolDur_4day,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Aug_Complete_4Day_AMS =</span> Complete_4Day_AMS)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># If there is no peak to 4day ratio, this was historic peak flow information</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">BestFitNotes =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Ratio_Peak_4d),<span class="st">"Estimated from Peak AMS"</span>,<span class="cn">NA</span>))</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing intervals. ifelse ensures it only computs missing ones</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>all_AMS <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Interval_Lower =</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(WaterYear<span class="sc">&lt;</span><span class="dv">1876</span>,<span class="fu">round</span>((DAratio<span class="sc">*</span><span class="fl">0.8</span><span class="sc">*</span>Unregulated_PeakFlow)<span class="sc">/</span>PtVratio_4day,<span class="dv">0</span>),<span class="cn">NA</span>),</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Interval_MostLikely =</span>                                 </span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(WaterYear<span class="sc">&lt;</span><span class="dv">1876</span>,<span class="fu">round</span>((DAratio<span class="sc">*</span><span class="fl">1.0</span><span class="sc">*</span>Unregulated_PeakFlow)<span class="sc">/</span>PtVratio_4day,<span class="dv">0</span>),<span class="cn">NA</span>),</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Interval_Upper =</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">ifelse</span>(WaterYear<span class="sc">&lt;</span><span class="dv">1876</span>,<span class="fu">round</span>((DAratio<span class="sc">*</span><span class="fl">1.2</span><span class="sc">*</span>Unregulated_PeakFlow)<span class="sc">/</span>PtVratio_4day,<span class="dv">0</span>),<span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <em>allAMS</em> dataframe can be exported to .csv or it can be further filtered to only include fields required for BestFit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exporting allAMS - commented out</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(all_AMS,"E:/1.Thurmond/Chapter 4/HH/Data/Savannah River - USGS Unregulated Study/Thurmond_Unreg_AMS_Peak_1day_4day.csv",row.names = F)</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting fields from allAMS that are required for BestFit</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>bestfit_input <span class="ot">&lt;-</span> all_AMS <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(WaterYear,Peak_Flow,Flow_notes,Unregulated_PeakFlow,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                                      Thurm_AMS_4day,BestFitNotes,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                                      Interval_Lower,Interval_MostLikely,Interval_Upper))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Export BestFit to csv - commented out</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">#write.csv(bestfit_input,"E:/1.Thurmond/Chapter 4/HH/Data/Savannah River - USGS Unregulated Study/Thurmond_Unreg_BestFitINPUT.csv",row.names = F)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="theme-usace" class="level2">
<h2 class="anchored" data-anchor-id="theme-usace">Theme USACE</h2>
<p>Move this before the other code blocks for ggplot themes. If issues continue, remove <em>+theme_USACE()</em> from the ggplot chunks</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>theme_USACE <span class="ot">&lt;-</span>  <span class="cf">function</span>(<span class="at">base_size =</span> <span class="dv">8</span>){<span class="fu">theme</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> <span class="st">'serif'</span>, <span class="at">color =</span> <span class="st">'black'</span>),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'black'</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>), </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">rect =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">'black'</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">vjust =</span> <span class="dv">3</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="st">'lines'</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> F),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'grey50'</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'grey75'</span>, <span class="at">linewidth =</span> <span class="fl">0.1</span>),</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">'white'</span>),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#defaults legend to upper left, can/should be overridden based on graph</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#legend.background = element_blank(),</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"lightgrey"</span>, <span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.5</span>),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this value should be adjusted dependent on </span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># graph with the addition of another </span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># theme(legend.position = c(X, Y)) argument after theme_USACE()</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># or... for no legend </span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># legend.position = element_blank(),</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#legend.title = element_blank(), </span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="dv">8</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)),</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="dv">0</span>, <span class="dv">0</span>)),</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks.length =</span> <span class="fu">unit</span>(<span class="fl">0.25</span> , <span class="st">'cm'</span>)</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>